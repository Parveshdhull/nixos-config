#!/bin/bash

HOSTNAME=$(hostname)

# Define repositories based on the hostname
if [[ "$HOSTNAME" == "luna" ]]; then
  REPOSITORIES=(
    "/mnt/storagebox-$HOSTNAME/$HOSTNAME /run/agenix/service/restic/pass"
    "sftp:storagebox:/home/$HOSTNAME /run/agenix/service/restic/pass"
  )
  echo "[INFO] Host is luna, using local and sftp repositories only."

elif [[ "$HOSTNAME" == "nova" ]]; then
  REPOSITORIES=(
    "/mnt/storagebox-$HOSTNAME/$HOSTNAME /run/agenix/service/restic/pass"
    "sftp:storagebox:/home/$HOSTNAME /run/agenix/service/restic/pass"
    "rclone:mega:storagebox /run/agenix/service/restic/pass-mega"
  )
  echo "[INFO] Host is nova, using all repositories including rclone."

else
  echo "[ERROR] No repositories defined for host: $HOSTNAME. Exiting."
  exit 0
fi

TODAY=$(date +%Y-%m-%d)
echo "[INFO] Today's date is: $TODAY"

# Loop through each repository and perform checks
for REPO in "${REPOSITORIES[@]}"; do
  REPO_PATH=$(echo "$REPO" | cut -d ' ' -f 1)
  PASSWORD_FILE=$(echo "$REPO" | cut -d ' ' -f 2-)

  echo "[INFO] Checking repository: $REPO_PATH"

  if [[ "$REPO_PATH" == rclone:* ]]; then
    export RCLONE_CONFIG=/run/agenix/service/rclone/conf
    echo "[INFO] Using rclone config: /run/agenix/service/rclone/conf"
  fi

  if ! restic -r "$REPO_PATH" --password-file "$PASSWORD_FILE" snapshots | grep -q "$TODAY"; then
    echo "[WARNING] No backup taken today for $REPO_PATH"
    echo -e "Subject: Restic Backup Alert - $HOSTNAME\n\nNo backup taken today for $REPO_PATH!" | msmtp "$EMAIL_RECIPIENT"
  else
    echo "[INFO] Backup taken today for $REPO_PATH"
  fi

  if ! restic -r "$REPO_PATH" --password-file "$PASSWORD_FILE" check; then
    echo "[ERROR] Repository $REPO_PATH failed the integrity check"
    echo -e "Subject: Restic Repository Health Alert - $HOSTNAME\n\nRepository $REPO_PATH failed the integrity check!" | msmtp "$EMAIL_RECIPIENT"
  else
    echo "[INFO] Repository $REPO_PATH passed the integrity check"
  fi
done

echo "[INFO] Restic backup check process completed for host: $HOSTNAME"
